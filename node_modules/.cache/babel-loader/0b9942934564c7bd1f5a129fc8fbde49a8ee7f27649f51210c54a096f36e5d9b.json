{"ast":null,"code":"import { jsx } from \"react/jsx-runtime\";\nimport { NoToneMapping, HalfFloatType } from \"three\";\nimport React, { createContext, forwardRef, useMemo, useEffect, useRef, useLayoutEffect, useImperativeHandle } from \"react\";\nimport { useThree, useFrame } from \"@react-three/fiber\";\nimport { EffectComposer as EffectComposer$1, RenderPass, NormalPass, DepthDownsamplingPass, Effect, EffectPass, EffectAttribute, Pass } from \"postprocessing\";\nimport { isWebGL2Available } from \"three-stdlib\";\nconst EffectComposerContext = createContext(null);\nconst isConvolution = effect => (effect.getAttributes() & EffectAttribute.CONVOLUTION) === EffectAttribute.CONVOLUTION;\nconst EffectComposer = React.memo(forwardRef((_ref, ref) => {\n  let {\n    children,\n    camera: _camera,\n    scene: _scene,\n    resolutionScale,\n    enabled = true,\n    renderPriority = 1,\n    autoClear = true,\n    depthBuffer,\n    enableNormalPass,\n    stencilBuffer,\n    multisampling = 8,\n    frameBufferType = HalfFloatType\n  } = _ref;\n  const {\n    gl,\n    scene: defaultScene,\n    camera: defaultCamera,\n    size\n  } = useThree();\n  const scene = _scene || defaultScene;\n  const camera = _camera || defaultCamera;\n  const [composer, normalPass, downSamplingPass] = useMemo(() => {\n    const webGL2Available = isWebGL2Available();\n    const effectComposer = new EffectComposer$1(gl, {\n      depthBuffer,\n      stencilBuffer,\n      multisampling: multisampling > 0 && webGL2Available ? multisampling : 0,\n      frameBufferType\n    });\n    effectComposer.addPass(new RenderPass(scene, camera));\n    let downSamplingPass2 = null;\n    let normalPass2 = null;\n    if (enableNormalPass) {\n      normalPass2 = new NormalPass(scene, camera);\n      normalPass2.enabled = false;\n      effectComposer.addPass(normalPass2);\n      if (resolutionScale !== void 0 && webGL2Available) {\n        downSamplingPass2 = new DepthDownsamplingPass({\n          normalBuffer: normalPass2.texture,\n          resolutionScale\n        });\n        downSamplingPass2.enabled = false;\n        effectComposer.addPass(downSamplingPass2);\n      }\n    }\n    return [effectComposer, normalPass2, downSamplingPass2];\n  }, [camera, gl, depthBuffer, stencilBuffer, multisampling, frameBufferType, scene, enableNormalPass, resolutionScale]);\n  useEffect(() => composer == null ? void 0 : composer.setSize(size.width, size.height), [composer, size]);\n  useFrame((_, delta) => {\n    if (enabled) {\n      const currentAutoClear = gl.autoClear;\n      gl.autoClear = autoClear;\n      if (stencilBuffer && !autoClear) gl.clearStencil();\n      composer.render(delta);\n      gl.autoClear = currentAutoClear;\n    }\n  }, enabled ? renderPriority : 0);\n  const group = useRef(null);\n  useLayoutEffect(() => {\n    var _a;\n    const passes = [];\n    const groupInstance = (_a = group.current) == null ? void 0 : _a.__r3f;\n    if (groupInstance && composer) {\n      const children2 = groupInstance.objects;\n      for (let i = 0; i < children2.length; i++) {\n        const child = children2[i];\n        if (child instanceof Effect) {\n          const effects = [child];\n          if (!isConvolution(child)) {\n            let next = null;\n            while ((next = children2[i + 1]) instanceof Effect) {\n              if (isConvolution(next)) break;\n              effects.push(next);\n              i++;\n            }\n          }\n          const pass = new EffectPass(camera, ...effects);\n          passes.push(pass);\n        } else if (child instanceof Pass) {\n          passes.push(child);\n        }\n      }\n      for (const pass of passes) composer == null ? void 0 : composer.addPass(pass);\n      if (normalPass) normalPass.enabled = true;\n      if (downSamplingPass) downSamplingPass.enabled = true;\n    }\n    return () => {\n      for (const pass of passes) composer == null ? void 0 : composer.removePass(pass);\n      if (normalPass) normalPass.enabled = false;\n      if (downSamplingPass) downSamplingPass.enabled = false;\n    };\n  }, [composer, children, camera, normalPass, downSamplingPass]);\n  useEffect(() => {\n    const currentTonemapping = gl.toneMapping;\n    gl.toneMapping = NoToneMapping;\n    return () => {\n      gl.toneMapping = currentTonemapping;\n    };\n  }, [gl]);\n  const state = useMemo(() => ({\n    composer,\n    normalPass,\n    downSamplingPass,\n    resolutionScale,\n    camera,\n    scene\n  }), [composer, normalPass, downSamplingPass, resolutionScale, camera, scene]);\n  useImperativeHandle(ref, () => composer, [composer]);\n  return /* @__PURE__ */jsx(EffectComposerContext.Provider, {\n    value: state,\n    children: /* @__PURE__ */jsx(\"group\", {\n      ref: group,\n      children\n    })\n  });\n}));\nexport { EffectComposer, EffectComposerContext };","map":{"version":3,"names":["EffectComposerContext","createContext","isConvolution","effect","getAttributes","EffectAttribute","CONVOLUTION","EffectComposer","React","memo","forwardRef","_ref","ref","children","camera","_camera","scene","_scene","resolutionScale","enabled","renderPriority","autoClear","depthBuffer","enableNormalPass","stencilBuffer","multisampling","frameBufferType","HalfFloatType","gl","defaultScene","defaultCamera","size","useThree","composer","normalPass","downSamplingPass","useMemo","webGL2Available","isWebGL2Available","effectComposer","EffectComposer$1","addPass","RenderPass","downSamplingPass2","normalPass2","NormalPass","DepthDownsamplingPass","normalBuffer","texture","useEffect","setSize","width","height","useFrame","_","delta","currentAutoClear","clearStencil","render","group","useRef","useLayoutEffect","passes","groupInstance","_a","current","__r3f","children2","objects","i","length","child","Effect","effects","next","push","pass","EffectPass","Pass","removePass","currentTonemapping","toneMapping","NoToneMapping","state","useImperativeHandle","jsx","Provider","value"],"sources":["/var/www/www-root/data/www/knigavl.ru/node_modules/@react-three/postprocessing/src/EffectComposer.tsx"],"sourcesContent":["import type { Camera, Scene, TextureDataType } from 'three'\nimport { HalfFloatType, NoToneMapping } from 'three'\nimport React, {\n  forwardRef,\n  useMemo,\n  useEffect,\n  useLayoutEffect,\n  createContext,\n  useRef,\n  useImperativeHandle,\n} from 'react'\nimport { useThree, useFrame } from '@react-three/fiber'\nimport {\n  EffectComposer as EffectComposerImpl,\n  RenderPass,\n  EffectPass,\n  NormalPass,\n  // @ts-ignore\n  DepthDownsamplingPass,\n  Effect,\n  Pass,\n  EffectAttribute,\n} from 'postprocessing'\nimport { isWebGL2Available } from 'three-stdlib'\n\nexport const EffectComposerContext = createContext<{\n  composer: EffectComposerImpl\n  normalPass: NormalPass | null\n  downSamplingPass: DepthDownsamplingPass | null\n  camera: Camera\n  scene: Scene\n  resolutionScale?: number\n}>(null!)\n\nexport type EffectComposerProps = {\n  enabled?: boolean\n  children: JSX.Element | JSX.Element[]\n  depthBuffer?: boolean\n  /** Only used for SSGI currently, leave it disabled for everything else unless it's needed */\n  enableNormalPass?: boolean\n  stencilBuffer?: boolean\n  autoClear?: boolean\n  resolutionScale?: number\n  multisampling?: number\n  frameBufferType?: TextureDataType\n  renderPriority?: number\n  camera?: Camera\n  scene?: Scene\n}\n\nconst isConvolution = (effect: Effect): boolean =>\n  (effect.getAttributes() & EffectAttribute.CONVOLUTION) === EffectAttribute.CONVOLUTION\n\nexport const EffectComposer = React.memo(\n  forwardRef<EffectComposerImpl, EffectComposerProps>(\n    (\n      {\n        children,\n        camera: _camera,\n        scene: _scene,\n        resolutionScale,\n        enabled = true,\n        renderPriority = 1,\n        autoClear = true,\n        depthBuffer,\n        enableNormalPass,\n        stencilBuffer,\n        multisampling = 8,\n        frameBufferType = HalfFloatType,\n      },\n      ref\n    ) => {\n      const { gl, scene: defaultScene, camera: defaultCamera, size } = useThree()\n      const scene = _scene || defaultScene\n      const camera = _camera || defaultCamera\n\n      const [composer, normalPass, downSamplingPass] = useMemo(() => {\n        const webGL2Available = isWebGL2Available()\n        // Initialize composer\n        const effectComposer = new EffectComposerImpl(gl, {\n          depthBuffer,\n          stencilBuffer,\n          multisampling: multisampling > 0 && webGL2Available ? multisampling : 0,\n          frameBufferType,\n        })\n\n        // Add render pass\n        effectComposer.addPass(new RenderPass(scene, camera))\n\n        // Create normal pass\n        let downSamplingPass = null\n        let normalPass = null\n        if (enableNormalPass) {\n          normalPass = new NormalPass(scene, camera)\n          normalPass.enabled = false\n          effectComposer.addPass(normalPass)\n          if (resolutionScale !== undefined && webGL2Available) {\n            downSamplingPass = new DepthDownsamplingPass({ normalBuffer: normalPass.texture, resolutionScale })\n            downSamplingPass.enabled = false\n            effectComposer.addPass(downSamplingPass)\n          }\n        }\n\n        return [effectComposer, normalPass, downSamplingPass]\n      }, [\n        camera,\n        gl,\n        depthBuffer,\n        stencilBuffer,\n        multisampling,\n        frameBufferType,\n        scene,\n        enableNormalPass,\n        resolutionScale,\n      ])\n\n      useEffect(() => composer?.setSize(size.width, size.height), [composer, size])\n      useFrame(\n        (_, delta) => {\n          if (enabled) {\n            const currentAutoClear = gl.autoClear\n            gl.autoClear = autoClear\n            if (stencilBuffer && !autoClear) gl.clearStencil()\n            composer.render(delta)\n            gl.autoClear = currentAutoClear\n          }\n        },\n        enabled ? renderPriority : 0\n      )\n\n      const group = useRef(null)\n      useLayoutEffect(() => {\n        const passes: Pass[] = []\n\n        // TODO: rewrite all of this with R3F v9\n        const groupInstance = (group.current as any)?.__r3f as { objects: unknown[] }\n\n        if (groupInstance && composer) {\n          const children = groupInstance.objects\n\n          for (let i = 0; i < children.length; i++) {\n            const child = children[i]\n\n            if (child instanceof Effect) {\n              const effects: Effect[] = [child]\n\n              if (!isConvolution(child)) {\n                let next: unknown = null\n                while ((next = children[i + 1]) instanceof Effect) {\n                  if (isConvolution(next)) break\n                  effects.push(next)\n                  i++\n                }\n              }\n\n              const pass = new EffectPass(camera, ...effects)\n              passes.push(pass)\n            } else if (child instanceof Pass) {\n              passes.push(child)\n            }\n          }\n\n          for (const pass of passes) composer?.addPass(pass)\n\n          if (normalPass) normalPass.enabled = true\n          if (downSamplingPass) downSamplingPass.enabled = true\n        }\n\n        return () => {\n          for (const pass of passes) composer?.removePass(pass)\n          if (normalPass) normalPass.enabled = false\n          if (downSamplingPass) downSamplingPass.enabled = false\n        }\n      }, [composer, children, camera, normalPass, downSamplingPass])\n\n      // Disable tone mapping because threejs disallows tonemapping on render targets\n      useEffect(() => {\n        const currentTonemapping = gl.toneMapping\n        gl.toneMapping = NoToneMapping\n        return () => {\n          gl.toneMapping = currentTonemapping\n        }\n      }, [gl])\n\n      // Memoize state, otherwise it would trigger all consumers on every render\n      const state = useMemo(\n        () => ({ composer, normalPass, downSamplingPass, resolutionScale, camera, scene }),\n        [composer, normalPass, downSamplingPass, resolutionScale, camera, scene]\n      )\n\n      // Expose the composer\n      useImperativeHandle(ref, () => composer, [composer])\n\n      return (\n        <EffectComposerContext.Provider value={state}>\n          <group ref={group}>{children}</group>\n        </EffectComposerContext.Provider>\n      )\n    }\n  )\n)\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}